{% extends "base.html" %}

{% block page_title %}All Tasks{% endblock %}

{% block content %}

<!-- Quick Stats -->
<div class="grid grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-lg p-4 border border-gray-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Total Tasks</p>
                <p class="text-2xl font-bold text-gray-900">{{ tasks|length }}</p>
            </div>
            <div class="text-3xl text-blue-400">
                <i class="fas fa-list-check"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg p-4 border border-gray-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Completed</p>
                <p class="text-2xl font-bold text-green-600">
                    {{ tasks|selectattr('completed')|list|length }}
                </p>
            </div>
            <div class="text-3xl text-green-400">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg p-4 border border-gray-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">In Progress</p>
                <p class="text-2xl font-bold text-orange-600">
                    {{ tasks|selectattr('status', 'equalto', 'doing')|list|length }}
                </p>
            </div>
            <div class="text-3xl text-orange-400">
                <i class="fas fa-hourglass-start"></i>
            </div>
        </div>
    </div>
</div>

<!-- Add New Task -->
<form method="POST" action="{{ url_for('add') }}" class="mb-6">
    <div class="flex gap-3">
        <input
            type="text"
            name="title"
            class="input-field flex-1"
            placeholder="Add a new task..."
            required
        >
        <button type="submit" class="btn-primary">
            <i class="fas fa-plus mr-2"></i>Add Task
        </button>
    </div>
</form>

<!-- Filter & Search Bar -->
<div class="filter-bar">
    <form method="GET" action="{{ url_for('index') }}" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <!-- Search -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <input
                    type="text"
                    name="q"
                    class="input-field w-full"
                    placeholder="Search by title or description..."
                    value="{{ search_query or '' }}"
                >
            </div>

            <!-- Status Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select name="status" class="input-field w-full" onchange="this.form.submit()">
                    <option value="">All Status</option>
                    <option value="todo" {% if filter_status == 'todo' %}selected{% endif %}>To Do</option>
                    <option value="doing" {% if filter_status == 'doing' %}selected{% endif %}>In Progress</option>
                    <option value="done" {% if filter_status == 'done' %}selected{% endif %}>Completed</option>
                </select>
            </div>

            <!-- Priority Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                <select name="priority" class="input-field w-full" onchange="this.form.submit()">
                    <option value="">All Priority</option>
                    <option value="3" {% if filter_priority == '3' %}selected{% endif %}>High</option>
                    <option value="2" {% if filter_priority == '2' %}selected{% endif %}>Medium</option>
                    <option value="1" {% if filter_priority == '1' %}selected{% endif %}>Low</option>
                </select>
            </div>

            <!-- Due Date Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                <select name="due" class="input-field w-full" onchange="this.form.submit()">
                    <option value="">All Dates</option>
                    <option value="overdue" {% if filter_due == 'overdue' %}selected{% endif %}>Overdue</option>
                    <option value="today" {% if filter_due == 'today' %}selected{% endif %}>Today</option>
                    <option value="week" {% if filter_due == 'week' %}selected{% endif %}>This Week</option>
                </select>
            </div>
        </div>

        <!-- Sort & Action Buttons -->
        <div class="flex gap-3 items-end">
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                <select name="sort" class="input-field w-full" onchange="this.form.submit()">
                    <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Newest First</option>
                    <option value="due_date" {% if sort_by == 'due_date' %}selected{% endif %}>Due Date</option>
                    <option value="priority" {% if sort_by == 'priority' %}selected{% endif %}>Priority</option>
                    <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Alphabetically</option>
                </select>
            </div>
            
            {% if search_query or filter_status or filter_priority or filter_due %}
            <a href="{{ url_for('index') }}" class="btn-secondary">
                <i class="fas fa-times mr-1"></i>Clear Filters
            </a>
            {% endif %}
        </div>
    </form>
</div>

<!-- Task List -->
<div class="space-y-3">
    {% if tasks %}
        {% for task in tasks %}
        <div class="task-card {% if task.completed %}completed{% endif %}" data-task-id="{{ task.id }}">
            <div class="flex gap-4">
                <!-- Checkbox -->
                <div class="checkbox-custom {% if task.completed %}checked{% endif %}" 
                     onclick="toggleTask({{ task.id }})">
                    {% if task.completed %}
                        <i class="fas fa-check text-sm"></i>
                    {% endif %}
                </div>

                <!-- Task Content -->
                <div class="flex-1">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 {% if task.completed %}line-through text-gray-500{% endif %}">
                                {{ task.title }}
                            </h3>
                            {% if task.description %}
                            <p class="text-sm text-gray-600 mt-1 line-clamp-2">
                                {{ task.description }}
                            </p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Metadata Badges -->
                    <div class="flex flex-wrap gap-2 items-center">
                        {% if task.priority %}
                        <span class="badge-priority {% if task.priority == 3 %}high{% elif task.priority == 2 %}medium{% else %}low{% endif %}">
                            <i class="fas fa-circle-exclamation mr-1"></i>
                            {% if task.priority == 3 %}High{% elif task.priority == 2 %}Medium{% else %}Low{% endif %}
                        </span>
                        {% endif %}

                        {% if task.status %}
                        <span class="badge-status {{ task.status }}">
                            <i class="fas fa-{% if task.status == 'done' %}check-circle{% elif task.status == 'doing' %}spinner{% else %}circle{% endif %} mr-1"></i>
                            {{ task.status|title }}
                        </span>
                        {% endif %}

                        {% if task.due_date %}
                        <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded flex items-center gap-1">
                            <i class="fas fa-calendar"></i>{{ task.due_date }}
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-2">
                    <a href="{{ url_for('edit', id=task.id) }}" class="icon-btn" title="Edit">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="{{ url_for('delete', id=task.id) }}" class="icon-btn danger" title="Delete" onclick="return confirm('Are you sure?')">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-inbox"></i>
            </div>
            <div class="empty-state-title">
                {% if search_query or filter_status or filter_priority or filter_due %}
                    No tasks match your filters
                {% else %}
                    No tasks yet
                {% endif %}
            </div>
            <div class="empty-state-text">
                {% if search_query or filter_status or filter_priority or filter_due %}
                    Try adjusting your search or filters
                {% else %}
                    Get started by adding your first task above
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<script>
function toggleTask(taskId) {
    fetch(`/toggle/${taskId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            const checkbox = taskElement.querySelector('.checkbox-custom');
            const taskText = taskElement.querySelector('h3');
            
            if (data.completed) {
                taskElement.classList.add('completed');
                checkbox.classList.add('checked');
                checkbox.innerHTML = '<i class="fas fa-check text-sm"></i>';
                taskText.classList.add('line-through', 'text-gray-500');
            } else {
                taskElement.classList.remove('completed');
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
                taskText.classList.remove('line-through', 'text-gray-500');
            }
        }
    })
    .catch(error => console.error('Error:', error));
}
</script>

{% endblock %}
